<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üé¨ Video Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background: #121212;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #ff4d4d;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 15px;
      border-radius: 8px;
      border: none;
      outline: none;
    }

    input::placeholder {
      color: #888;
    }

    textarea::placeholder {
      color: #777;
    }

    input {
      background: #fff;
      color: #000;
    }

    textarea {
      height: 140px;
      resize: vertical;
      background: #fefefe;
      color: #000;
      border: 2px solid #999;
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #ff2d55;
      color: white;
      font-weight: bold;
      font-size: 15px;
    }

    button:hover {
      background: #cc0033;
    }

    #btnGroup {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .video-block {
      background: rgba(255,255,255,0.06);
      border-left: 4px solid #ff4d4d;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 15px;
    }

    .video-top {
      display: flex;
      align-items: center;
    }

    .thumb {
      width: 90px;
      height: 90px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 12px;
      cursor: pointer;
    }

    .video-title {
      font-size: 14px;
      font-weight: 500;
    }

    .video-serial {
      color: #f1c40f;
      font-weight: bold;
      margin-right: 6px;
    }

    .not-found {
      color: #ff6b6b;
      font-weight: bold;
    }

    #customPopup {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
    }

    #popupContent {
      background: #2ecc71;
      color: #fff;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: bold;
      border: 2px solid #2ecc71;
    }
  </style>
</head>
<body>

<h2>üé¨ Video Tracker</h2>

<!-- üîç Search -->
<input type="text" id="searchBox" placeholder="Search YouTube (Last Hour)" />
<button onclick="searchYouTube()">üîç Search</button>

<!-- üìù Serial & Link -->
<div style="display:flex;gap:10px;margin-top:15px;">
  <input type="text" id="serialInput" placeholder="Serial" style="flex:1;" />
  <input type="text" id="linkInput" placeholder="YouTube Link" style="flex:3;" />
  <button onclick="saveEntry()">üíæ Save</button>
</div>

<!-- üìã Preview -->
<textarea id="ytLinks" readonly></textarea>

<!-- ‚úÖ Submit / ‚ôªÔ∏è Reset -->
<div id="btnGroup">
  <button onclick="checkVideos()">‚úÖ Submit</button>
  <button onclick="resetAll()" style="background:#666;">‚ôªÔ∏è Reset</button>
</div>

<!-- Results + Loader -->
<div id="loader" style="display:none;">‚è≥ Tracking... please wait</div>
<div id="results" class="result"></div>

<!-- Popup -->
<div id="customPopup" style="display: none;">
  <div id="popupContent"></div>
</div>

<script>
  const textarea = document.getElementById("ytLinks");

  // Load saved preview on reload
  window.onload = () => {
    const saved = localStorage.getItem("yt_preview");
    if (saved) textarea.value = saved;
  };

  function saveEntry() {
    const serial = document.getElementById("serialInput").value.trim();
    const link = document.getElementById("linkInput").value.trim();
    if (!serial || !link) return alert("Enter both Serial and Link.");

    let current = localStorage.getItem("yt_preview") || "";
    const lines = current.trim().split("\n").filter(Boolean);
    lines.push(`${serial} ${link}`);

    const sortedLines = lines.sort((a, b) => {
      const sa = parseInt(a.split(" ")[0]);
      const sb = parseInt(b.split(" ")[0]);
      return sa - sb;
    });

    const updated = sortedLines.join("\n");
    localStorage.setItem("yt_preview", updated);

    // Force refresh
    location.reload();
  }

  function resetAll() {
    textarea.value = "";
    localStorage.removeItem("yt_preview");
    document.getElementById("results").innerHTML = "";
  }

  function searchYouTube() {
    const query = document.getElementById('searchBox').value.trim();
    if (!query) return alert("Please enter a search term.");
    const encoded = encodeURIComponent(query);
    const url = `https://www.youtube.com/results?search_query=${encoded}&sp=EgIIAQ%253D%253D`; // Last Hour Filter
    window.open(url, "_blank");
  }

  const YT_API_KEY = "AIzaSyDFvv93DEI4LG-uCwR8EGWm1lQ_i6Ob1n8";

  function extractVideoID(url) {
    const regExp = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|embed)\/|.*[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
    const match = url.match(regExp);
    return match ? match[1] : null;
  }

  async function checkVideos() {
    const input = textarea.value.trim();
    const lines = input.split("\n");
    const resultsDiv = document.getElementById("results");
    const loader = document.getElementById("loader");
    resultsDiv.innerHTML = "";
    loader.style.display = "block";

    const tasks = lines.map((line, i) => {
      line = line.trim();
      if (!line) return null;

      let serial = "";
      let url = line;

      const match = line.match(/^(\d+)\.?\s+(https?:\/\/[^\s]+)$/);
      if (match) {
        serial = match[1];
        url = match[2];
      } else {
        serial = (i + 1).toString();
      }

      const videoId = extractVideoID(url);
      const block = document.createElement("div");
      block.className = "video-block";

      if (!videoId) {
        block.innerHTML = `
          <div class="video-title">
            <span class="video-serial">${serial}</span>
            <span class="not-found">‚ùå Invalid or Not Found</span><br>
            <a href="${url}" target="_blank">${url}</a>
          </div>
        `;
        return block;
      }

      return fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`)
        .then(res => res.json())
        .then(data => {
          block.innerHTML = `
            <div class="video-top">
              <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" class="thumb" onclick="window.open('https://youtu.be/${videoId}', '_blank')">
              <div class="video-info">
                <div class="video-title">
                  <span class="video-serial">${serial}</span>${data.title}
                </div>
              </div>
            </div>
          `;
          return block;
        })
        .catch(() => {
          block.innerHTML = `
            <div class="video-title">
              <span class="video-serial">${serial}</span>
              <span class="not-found">‚ùå Not Found</span><br>
              <a href="${url}" target="_blank">${url}</a>
            </div>
            <button class="check-btn" onclick="checkViaApi('${videoId}', '${serial}')">üîç Check</button>
          `;
          return block;
        });
    });

    const allBlocks = await Promise.all(tasks.map(p => p instanceof Promise ? p : Promise.resolve(p)));
    allBlocks.forEach(block => {
      if (block) resultsDiv.appendChild(block);
    });

    loader.style.display = "none";
  }

  function showPopup(message, success = true) {
    const popup = document.getElementById("customPopup");
    const content = document.getElementById("popupContent");

    content.style.borderColor = success ? "#2ecc71" : "#e74c3c";
    content.style.background = success ? "#2ecc71" : "#e74c3c";
    content.innerHTML = message;

    popup.style.display = "block";

    setTimeout(() => {
      popup.style.display = "none";
    }, 3000);
  }

  async function checkViaApi(videoId, serial) {
    const apiURL = `https://www.googleapis.com/youtube/v3/videos?part=status&id=${videoId}&key=${YT_API_KEY}`;
    try {
      const res = await fetch(apiURL);
      const json = await res.json();

      if (json.items && json.items.length > 0) {
        const status = json.items[0].status.uploadStatus;
        if (status && status.toLowerCase() !== "deleted") {
          showPopup(`‚úÖ Video #${serial} is available`, true);
        } else {
          showPopup(`‚ùå Video #${serial} is deleted or unavailable`, false);
        }
      } else {
        showPopup(`‚ùå Video #${serial} not found in database`, false);
      }
    } catch (e) {
      showPopup(`‚ö†Ô∏è Error checking video #${serial}`, false);
    }
  }
</script>

</body>
</html>
